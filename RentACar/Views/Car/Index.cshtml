@model RentACar.Models.CarsViewModel

<div class="no-bottom no-top zebra" id="content">
    <div id="top"></div>

    <!-- Header Section -->
    <section id="subheader" class="jarallax text-light">
        <img src="images/background/2.jpg" class="jarallax-img" alt="">
        <div class="center-y relative text-center">
            <div class="container">
                <div class="row">
                    <div class="col-md-12 text-center">
                        <h1>Cars</h1>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filter & Car List Section -->
    <section id="section-cars">
        <div class="container">
            <div class="row">

                <!-- Filter Sidebar -->
                <div class="col-lg-3">
                    <!-- Search -->
                    <div class="item_filter_group">
                        <h4>Search</h4>
                        <div class="de_form">
                            <input type="text" placeholder="Search by name..." id="search-input" class="form-control" />
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="item_filter_group">
                        <h4>Car Body Type</h4>
                        <div class="de_form">
                            @foreach (var bodyType in Model.Categories)
                            {
                                <div class="de_checkbox">
                                    <input id="car_body_type_@bodyType.Id" type="checkbox" value="@bodyType.Id" class="category-filter" />
                                    <label for="car_body_type_@bodyType.Id">@bodyType.Name</label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Price Filter -->
                    <div class="item_filter_group">
                        <h4>Price Range</h4>
                        <input type="number" id="minPrice" placeholder="Min Price" class="form-control mb-2" />
                        <input type="number" id="maxPrice" placeholder="Max Price" class="form-control mb-2" />
                        <div id="price-slider" style="margin-top:60px;"></div>
                    </div>
                </div>

                <!-- Car Cards -->
                <div class="col-lg-9">
                    <div class="row" id="car-list">
                        @foreach (var item in Model.Cars)
                        {
                            <div class="col-xl-4 col-lg-6 car-parent">
                                <div class="de-item mb-2 car-card p-2"
                                     data-car-id="@item.Id"
                                     data-car-name="@item.Name"
                                     data-car-image="@item.ImageUrl"
                                     data-price="@item.PricePerDay"
                                     data-category-id="@item.CategoryId">

                                    <a href="@Url.Action("Details", "Car", new { id = item.Id })">
                                        <div class="d-img">
                                            <img src="images/car/@item.ImageUrl" class="img-fluid" alt="@item.Name">
                                        </div>
                                    </a>

                                    <div class="d-info">
                                        <div class="d-text">
                                            <h4 class="mb-1">@item.Name</h4>

                                            <div class="d-item_like">
                                                <i class="fa fa-heart favorite-icon"
                                                   data-id="@item.Id"
                                                   style="cursor:pointer;"></i>
                                            </div>

                                            <div class="d-attributes mb-1">
                                                <div class="d-attr-row">
                                                    <span class="d-atr"><img src="images/icons/1-green.svg" alt="">@item.Seats</span>
                                                    <span class="d-atr"><img src="images/icons/2-green.svg" alt="">@item.Doors</span>
                                                    <span class="d-atr"><img src="images/icons/3-green.svg" alt="">@item.Luggage</span>
                                                </div>
                                                <div class="d-category">
                                                    <span class="d-atr"><img src="images/icons/4-green.svg" alt="">@item.Category?.Name</span>
                                                </div>
                                            </div>

                                            <div class="d-price">
                                                Günlük qiymət <span>₼@item.PricePerDay.ToString("N0")</span>
                                                <a href="/Booking/QuickBooking?carId=@item.Id" class="btn-main btn-sm">Rent Now</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-center align-items-center mt-3 gap-2">
                        <div id="pagination-prev" class="page-arrow" style="cursor:pointer;">&#8249;</div>
                        <div id="pagination-scroll" class="d-flex overflow-auto" style="gap:5px;"></div>
                        <div id="pagination-next" class="page-arrow" style="cursor:pointer;">&#8250;</div>
                    </div>

                </div>

            </div>
        </div>
    </section>
</div>

<style>
    .car-card {
        min-height: 220px;
        display: flex;
        flex-direction: column;
    }

        .car-card .d-img {
            height: 130px;
            overflow: hidden;
        }

            .car-card .d-img img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .car-card .d-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

    .favorite-icon.active {
        color: red !important;
    }

    #price-slider {
        width: 100%;
    }

    .page-scroll-btn {
        min-width: 40px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #ccc;
        border-radius: 4px;
        cursor: pointer;
        flex-shrink: 0;
    }

        .page-scroll-btn.active {
            background: #007bff;
            color: white;
        }

    .page-arrow {
        font-size: 24px;
        user-select: none;
        padding: 0 10px;
        color: #007bff;
    }

    #pagination-scroll::-webkit-scrollbar {
        height: 6px;
    }

    #pagination-scroll::-webkit-scrollbar-thumb {
        background-color: #007bff;
        border-radius: 3px;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const favoritesKey = "favoriteCars";
            let favorites = JSON.parse(localStorage.getItem(favoritesKey)) || [];

            const favoritesMenu = document.getElementById("favorites-menu-list");
            const favoritesToggle = document.getElementById("favorites-toggle");

            // --- FAVORITES LOGIC ---
            function renderFavoritesDropdown() {
                if (!favoritesMenu) return;

                favoritesMenu.innerHTML = "";
                if (favorites.length === 0) {
                    favoritesMenu.innerHTML = "<li>Seçilmiş yoxdur</li>";
                    return;
                }

                favorites.forEach(car => {
                    favoritesMenu.insertAdjacentHTML("beforeend", `
                        <li>
                            <a href="/Car/Details/${car.id}" style="display:flex;align-items:center;gap:5px;text-decoration:none;color:inherit;">
                                <img src="/images/car/${car.image}" alt="${car.name}" style="width:50px;height:30px;object-fit:cover;" />
                                <span>${car.name}</span>
                            </a>
                            <span class="remove-favorite" data-id="${car.id}" style="margin-left:auto;cursor:pointer;color:red;">&times;</span>
                        </li>
                    `);
                });

                document.querySelectorAll(".remove-favorite").forEach(btn => {
                    btn.addEventListener("click", function () {
                        const id = parseInt(btn.getAttribute("data-id"));
                        favorites = favorites.filter(f => f.id !== id);
                        localStorage.setItem(favoritesKey, JSON.stringify(favorites));
                        renderFavoritesDropdown();
                        updateCarHearts();
                    });
                });
            }

            function toggleFavorite(carId, name, image, iconElement) {
                let existing = favorites.find(f => f.id === carId);
                if (existing) {
                    favorites = favorites.filter(f => f.id !== carId);
                    iconElement.classList.remove("active");
                } else {
                    favorites.push({ id: carId, name: name, image: image });
                    iconElement.classList.add("active");
                }
                localStorage.setItem(favoritesKey, JSON.stringify(favorites));
                renderFavoritesDropdown();
            }

            function updateCarHearts() {
                document.querySelectorAll(".favorite-icon").forEach(icon => {
                    const carId = parseInt(icon.getAttribute("data-id"));
                    if (favorites.find(f => f.id === carId)) {
                        icon.classList.add("active");
                    } else {
                        icon.classList.remove("active");
                    }
                });
            }

            document.querySelectorAll(".favorite-icon").forEach(icon => {
                icon.addEventListener("click", function () {
                    const card = icon.closest(".car-card");
                    const carId = parseInt(icon.getAttribute("data-id"));
                    const name = card.getAttribute("data-car-name");
                    const image = card.getAttribute("data-car-image");
                    toggleFavorite(carId, name, image, icon);
                });
            });

            if (favoritesToggle) {
                favoritesToggle.addEventListener("click", function (e) {
                    e.preventDefault();
                    favoritesMenu.style.display = (favoritesMenu.style.display === "block") ? "none" : "block";
                });
            }

            // ✅ təhlükəsiz klik yoxlaması
            document.addEventListener("click", function (e) {
                if (favoritesMenu && favoritesToggle) {
                    if (!favoritesMenu.contains(e.target) && !favoritesToggle.contains(e.target)) {
                        favoritesMenu.style.display = "none";
                    }
                }
            });

            renderFavoritesDropdown();
            updateCarHearts();

            // --- FILTER + PAGINATION LOGIC ---
            function filterCars() {
                var search = $("#search-input").val().toLowerCase();
                var selectedCategories = $(".category-filter:checked").map(function () { return $(this).val(); }).get();
                var minPrice = parseFloat($("#minPrice").val()) || 0;
                var maxPrice = parseFloat($("#maxPrice").val()) || Number.MAX_VALUE;

                $("#car-list .car-parent").each(function () {
                    var card = $(this).find(".car-card");
                    var name = card.data("car-name").toLowerCase();
                    var categoryId = card.data("category-id").toString();
                    var price = parseFloat(card.data("price"));

                    var matchSearch = search === "" || name.includes(search);
                    var matchCategory = selectedCategories.length === 0 || selectedCategories.includes(categoryId);
                    var matchPrice = price >= minPrice && price <= maxPrice;

                    if (matchSearch && matchCategory && matchPrice) $(this).addClass("filtered").show();
                    else $(this).removeClass("filtered").hide();
                });

                applyPagination();
            }

            var carsPerPage = 6;
            var currentPage = 1;

            function applyPagination() {
                var cars = $("#car-list .car-parent.filtered");
                if (cars.length === 0) cars = $("#car-list .car-parent");

                var totalPages = Math.ceil(cars.length / carsPerPage);
                if (currentPage > totalPages) currentPage = totalPages || 1;

                var start = (currentPage - 1) * carsPerPage;
                var end = start + carsPerPage;

                cars.hide().slice(start, end).show();

                var scrollDiv = $("#pagination-scroll").empty();
                for (var i = 1; i <= totalPages; i++) {
                    var btn = $("<div class='page-scroll-btn'>" + i + "</div>");
                    if (i === currentPage) btn.addClass("active");
                    btn.on("click", (function (page) { return function () { currentPage = page; applyPagination(); }; })(i));
                    scrollDiv.append(btn);
                }
            }

            $("#pagination-prev").on("click", function () {
                if (currentPage > 1) { currentPage--; applyPagination(); }
            });

            $("#pagination-next").on("click", function () {
                var cars = $("#car-list .car-parent.filtered");
                if (cars.length === 0) cars = $("#car-list .car-parent");
                var totalPages = Math.ceil(cars.length / carsPerPage);
                if (currentPage < totalPages) { currentPage++; applyPagination(); }
            });

            $(document).ready(function () {
                $("#car-list .car-parent").addClass("filtered");
                applyPagination();
            });

            $("#search-input").on("input", filterCars);
            $(".category-filter").on("change", filterCars);
            $("#minPrice, #maxPrice").on("input", filterCars);
        });
    </script>
}

}